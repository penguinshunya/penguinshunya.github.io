---
layout: problem
site: AtCoder
prefix: ABC129 F
problem_name: Takahashi's Basics in Education and Learning
level: 600点
problem_url: https://atcoder.jp/contests/abc129/tasks/abc129_f
---
<h2>考察</h2>
<p>まず、等差数列の要素の桁数が決まっているものとします。なぜ決まっているものとするかというと、「等差数列の要素は全て$10^{18}$未満」という制約があるからです。この制約により、等差数列の全ての要素を左から右に順番に並べたときに、以下のことが言えます。</p>
<ol>
  <li>$N$番目の要素の桁数は、$N-1$番目の要素の桁数以上である</li>
  <li>要素の桁数を$k$とおくと、必ず$1 \le k \le 18$が成り立つ</li>
</ol>
<p>つまり、もし桁数が決まっているときの解を高速に求めることができれば、それを高々$18$回行うだけで、最終的な答えが得られます。ということで、桁数が決まっている場合について考察します。</p>
<hr>
<p>初項$x$、公差$y$、要素の桁数を$k$とおきます。まずは$3$番目の要素の解がどのような式で表せるかを手元で試してみます。すると次のような式になります。</p>
$$A_3 = x(10^{2k} + 10^k + 1) + y(0 \cdot 10^{2k} + 1 \cdot 10^k + 2 \cdot 1)$$
<p>一般化すると、$N$番目の要素の解は次の式になります。</p>
$$A_N = x(10^{(N-1) \cdot k} + \ldots + 10^{0 \cdot k}) + y(0 \cdot 10^{(N-1)k} + \ldots + (N - 1) \cdot 10^{0 \cdot k})$$
<p>見通しを良くするために$ \sum $を導入して$T = 10^k$とおきます。最終的には次の式になります。</p>
$$A_N = x \sum_{i=0}^{N-1} T^i + y \sum_{i=0}^{N-1} (i \cdot T^{N - 1 - i})$$
<p>つまり、$\sum T^i$と$\sum (i \cdot T^{N - 1 - i})$を高速に求めることができれば、$A_N$を高速に求めることができます。ということで、これらをどのようにして高速に求めるかについて考えます。</p>
<h3>等比数列の和の公式を使う</h3>
<p>$g(N) = \sum T^i$、$h(N) = \sum (i \cdot T^{N - 1 - i})$とおきます。$g(N)$は<a target="_blank" href="https://mathtrain.jp/sumtouhi">等比数列の和の公式</a>を使って、$h(N)$は<a target="_blank" href="https://mathtrain.jp/ar">等比数列と等差数列の和の求め方</a>を使って求められます。しかし、これらの式は割り算を含んでいます。<br>
今回の問題では、最終的に$M$で割った余りを求めたいので、途中の計算をmod $M$を取りながら進めていくことになります。しかし、もし$M$が素数でないなら、「割り算を含む計算」を行うことは簡単ではありません。</p>
<p>よって、割り算を使わずに$g(N)$と$h(N)$を求めたいです。そこで次のことを考えます。</p>
<h3>$g(N)$から$g(N+1)$と$g(N \times 2)$を求められないかを考える</h3>
<p>もし$g(N)$から$g(N+1)$と$g(N \times 2)$を求めることができれば、$N$が巨大な整数であっても高速に答えを求めることができます。たとえば$N = 10,000$のときは、計$17$回の再帰で済みます。</p>
<p>$g(N)$から$g(N + 1)$を求めるのは簡単で、$g(N + 1) = g(N) + T^N$とすればよいです。$g(N)$から$g(N \times 2)$を求める方法ですが、一度手元で$g(2)$と$g(4)$の式を書いてみて、どのようにして$g(2)$の式から$g(4)$の式にできるかを考えるという方法があります（このあたりを上手くやる方法はよくわかりません…）。</p>
<p>この方法で、$g(N \times 2) = g(N) \times (T^N + 1)$という式が立てられます。あとは$g(1)$のときの値を定義すれば終わりです。これは自明で、$g(1) = 1$です。</p>
<p>同じ方法で、$h(N)$のときの漸化式を立てます。最終的には次のような式になります。</p>
\[
\begin{cases}
  g(1)&=& 1 \\
  g(N + 1)&=& g(N) + T^N \\
  g(N \times 2)&=& g(N) \times (T^N + 1)
\end{cases}
\]
\[
\begin{cases}
  h(1)&=& 0 \\
  h(N + 1)&=& h(N) + g(N) \\
  h(N \times 2)&=& h(N) \times (T^N + 1) + N \times g(N)
\end{cases}
\]
<p>これで、$g(N)$と$h(N)$を高速で求められるようになりました。よって$A_N$も高速で求めることができ、この問題を解くことができました。計算量は$O(c \log^3N)$（$c$は桁数の種類数）です。</p>
<h2>実装</h2>
<a target="_blank" href="https://atcoder.jp/contests/abc129/submissions/5875120">ソースコードはこちらです</a>。
<h2>感想</h2>
<p>$f(N + 1)$と$f(N \times 2)$の漸化式を立てるという方法は、解説放送で使われていた方法です。この方法を使うことで、「等比数列の和の公式」を知らなくても等比数列の和を求めることができます。ということで、競プロの面白さを改めて感じた問題でした。</p>
